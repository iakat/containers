name: code-ubuntu
on:
  schedule:
    - cron: "0 10 * * *"
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
    branches:
      - "main"
jobs:
  build-base:
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: ubuntu
            context: images/base
          - name: minimal
            context: images/minimal
        platform:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: coder/images
          submodules: recursive
      - name: Build and push with Kaniko
        uses: aevea/action-kaniko@master
        with:
          image: ${{ github.repository }}/code
          tags: latest-${{ matrix.platform.arch }},${{ github.sha }}-${{ matrix.platform.arch }}
          path: ${{ matrix.image.context }}
          build_file: ubuntu.Dockerfile
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          cache: true
          cache_registry: ${{ matrix.image.name }}/cache
          extra_args: >-
            --snapshot-mode=redo --use-new-run --cache-run-layers --cache-copy-layers --cache-ttl=168h --compressed-caching=false --cleanup
          kaniko_image: martizih/kaniko:latest
  build-derived:
    needs: build-base
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: desktop
            context: images/desktop
          - name: golang
            context: images/golang
          - name: java
            context: images/java
          - name: node
            context: images/node
        platform:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: coder/images
          submodules: recursive
      - name: Replace base image references
        run: |
          DOCKERFILE="${{ matrix.image.context }}/ubuntu.Dockerfile"
          sed -i 's|codercom/enterprise-base:ubuntu|ghcr.io/${{ github.repository }}/ubuntu:latest|g' "$DOCKERFILE"
          sed -i 's|codercom/enterprise-minimal:latest|ghcr.io/${{ github.repository }}/minimal:latest|g' "$DOCKERFILE"
      - name: Build and push with Kaniko
        uses: aevea/action-kaniko@master
        with:
          image: ${{ matrix.image.name }}
          path: ${{ matrix.image.context }}
          build_file: ubuntu.Dockerfile
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          cache: true
          cache_registry: ${{ matrix.image.name }}/cache
          extra_args: >-
            --snapshot-mode=redo --use-new-run --cache-run-layers --cache-copy-layers --cache-ttl=168h --compressed-caching=false --cleanup
          kaniko_image: martizih/kaniko:latest
  manifest:
    needs: [build-base, build-derived]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: [ubuntu, minimal, desktop, golang, java, node]
    steps:
      - name: Setup crane
        uses: imjasonh/setup-crane@v0.4
      - name: Login to GHCR
        run: crane auth login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
      - name: Create and push manifest
        run: |-
          IMAGE="ghcr.io/${{ github.repository }}/${{ matrix.image }}"

          for TAG in latest ${{ github.sha }}; do
            crane index append \
              --tag "${IMAGE}:${TAG}" \
              --manifest "${IMAGE}:${TAG}-amd64" \
              --manifest "${IMAGE}:${TAG}-arm64"
          done

          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            crane index append \
              --tag "${IMAGE}:${VERSION}" \
              --manifest "${IMAGE}:${VERSION}-amd64" \
              --manifest "${IMAGE}:${VERSION}-arm64"
          fi
